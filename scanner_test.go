// Copyright (c) 2014 Dataence, LLC. All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package sequence

import (
	"strings"
	"testing"

	"github.com/dataence/assert"
)

var (
	testdata map[string]string = map[string]string{
		"jan 12 06:49:41 irc sshd[7034]: pam_unix(sshd:auth): authentication failure; logname= uid=0 euid=0 tty=ssh ruser= rhost=218-161-81-238.hinet-ip.hinet.net  user=root":                                                                                                                                  "%ts%[%integer%]:(:):;==%integer%=%integer%====",
		"jan 12 06:49:42 irc sshd[7034]: failed password for root from 218.161.81.238 port 4228 ssh2":                                                                                                                                                                                                           "%ts%[%integer%]:%ipv4%%integer%",
		"9.26.157.45 - - [16/jan/2003:21:22:59 -0500] \"get /wssamples/ http/1.1\" 200 1576":                                                                                                                                                                                                                    "%ipv4%--[%ts%]\"\"%integer%%integer%",
		"209.36.88.3 - - [03/may/2004:01:19:07 +0000] \"get http://npkclzicp.xihudohtd.ngm.au/abramson/eiyscmeqix.ac;jsessionid=b0l0v000u0?sid=00000000&sy=afr&kw=goldman&pb=fin&dt=selectrange&dr=0month&so=relevance&st=nw&ss=afr&sf=article&rc=00&clspage=0&docid=fin0000000r0jl000d00 http/1.0\" 200 27981": "%ipv4%--[%ts%]\"%url%\"%integer%%integer%",
		"4/5/2012 17:55,172.23.1.101,1101,172.23.0.10,139, generic protocol command decode,3, [1:2100538:17] gpl netbios smb ipc$ unicode share access ,tcp ttl:128 tos:0x0 id:1643 iplen:20 dgmlen:122 df,***ap*** seq: 0xcef93f32  ack: 0xc40c0bb  n: 0xfc9c  tcplen: 20,":                                    "%ts%,%ipv4%,%integer%,%ipv4%,%integer%,,%integer%,[%integer%:%integer%:%integer%],:%integer%::%integer%:%integer%:%integer%,::n::%integer%,",
		"2012-04-05 17:54:47     local4.info     172.23.0.1      %asa-6-302015: built outbound udp connection 1315679 for outside:193.0.14.129/53 (193.0.14.129/53) to inside:172.23.0.10/64048 (10.32.0.1/52130)":                                                                                              "%ts%%ipv4%:%integer%:%ipv4%/%integer%(%ipv4%/%integer%):%ipv4%/%integer%(%ipv4%/%integer%)",
		"may  2 19:00:02 dlfssrv sendmail[18980]: taa18980: from user daemon: size is 596, class is 0, priority is 30596, and nrcpts=1, message id is <200305021400.taa18980@dlfssrv.in.ibm.com>, relay=daemon@localhost":                                                                                       "%ts%[%integer%]:::%integer%,%integer%,%integer%,=%integer%,<>,=",
		"jan 12 06:49:56 irc last message repeated 6 times":                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  "%ts%%integer%",
		"9.26.157.44 - - [16/jan/2003:21:22:59 -0500] \"get http://wssamples http/1.1\" 301 315":                                                                                                                                                                                                                                                                                                                                                                                                                                             "%ipv4%--[%ts%]\"%url%\"%integer%%integer%",
		"2012-04-05 17:51:26     local4.info     172.23.0.1      %asa-6-302016: teardown udp connection 1315632 for inside:172.23.0.2/514 to identity:172.23.0.1/514 duration 0:09:23 bytes 7999":                                                                                                                                                                                                                                                                                                                                            "%ts%%ipv4%:%integer%:%ipv4%/%integer%:%ipv4%/%integer%%integer%:%integer%:%integer%%integer%",
		"id=firewall time=\"2005-03-18 14:01:43\" fw=topsec priv=4 recorder=kernel type=conn policy=504 proto=tcp rule=deny src=210.82.121.91 sport=4958 dst=61.229.37.85 dport=23124 smac=00:0b:5f:b2:1d:80 dmac=00:04:c1:8b:d8:82":                                                                                                                                                                                                                                                                                                         "==\"%ts%\"==%integer%===%integer%===%ipv4%=%integer%=%ipv4%=%integer%=%mac%=%mac%",
		"mar 01 09:42:03.875 pffbisvr smtp[2424]: 334 warning: denied access to command 'ehlo vishwakstg1.msn.vishwak.net' from [209.235.210.30]":                                                                                                                                                                                                                                                                                                                                                                                            "%ts%[%integer%]:%integer%:''[%ipv4%]",
		"mar 01 09:45:02.596 pffbisvr smtp[2424]: 121 statistics: duration=181.14 user=<egreetings@vishwak.com> id=zduqd sent=1440 rcvd=356 srcif=d45f49a2-b30 src=209.235.210.30/61663 cldst=192.216.179.206/25 svsrc=172.17.74.195/8423 dstif=fd3c875c-064 dst=172.17.74.52/25 op=\"to 1 recips\" arg=<vishwakstg1ojte15fo000033b4@vishwakstg1.msn.vishwak.net> result=\"250 m2004030109385301402 message accepted for delivery\" proto=smtp rule=131 (denied access to command 'ehlo vishwakstg1.msn.vishwak.net' from [209.235.210.30])": "%ts%[%integer%]:%integer%:=%float%=<>==%integer%=%integer%==%ipv4%/%integer%=%ipv4%/%integer%=%ipv4%/%integer%==%ipv4%/%integer%=\"%integer%\"=<>=\"%integer%\"==%integer%(''[%ipv4%])",
	}
)

func TestMessageSignature(t *testing.T) {
	msg := &message{}

	for data, sig := range testdata {
		msg.data = data
		err := msg.tokenize()
		assert.NoError(t, true, err)

		newsig := msg.tokens.Signature()
		//glog.Debugf("newsig = %s", newsig)
		assert.Equal(t, true, sig, newsig)

		//glog.Debugf("\n%s\n%s\n%s", data, newsig, msg.printTokens())
	}
}

var (
	messages map[string]Sequence = map[string]Sequence{
		"Jan 12 06:49:41 irc sshd[7034]: pam_unix(sshd:auth): authentication failure; logname= uid=0 euid=0 tty=ssh ruser= rhost=218-161-81-238.hinet-ip.hinet.net  user=root": Sequence{
			Token{TokenTS, FieldUnknown, "jan 12 06:49:41", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "irc", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "sshd", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "[", false, false, 0},
			Token{TokenInteger, FieldUnknown, "7034", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "]", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "pam_unix", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "(", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "sshd", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "auth", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ")", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "authentication", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "failure", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ";", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "logname", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "uid", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenInteger, FieldUnknown, "0", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "euid", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenInteger, FieldUnknown, "0", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "tty", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenString, FieldUnknown, "ssh", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "ruser", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "rhost", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenString, FieldUnknown, "218-161-81-238.hinet-ip.hinet.net", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "user", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenString, FieldUnknown, "root", false, true, 0},
		},

		"Jan 12 06:49:42 irc sshd[7034]: Failed password for root from 218.161.81.238 port 4228 ssh2": Sequence{
			Token{TokenTS, FieldUnknown, "jan 12 06:49:42", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "irc", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "sshd", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "[", false, false, 0},
			Token{TokenInteger, FieldUnknown, "7034", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "]", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "failed", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "password", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "for", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "root", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "from", false, false, 0},
			Token{TokenIPv4, FieldUnknown, "218.161.81.238", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "port", false, false, 0},
			Token{TokenInteger, FieldUnknown, "4228", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "ssh2", false, false, 0},
		},

		//"Jan 13 17:25:59 jlz sshd[19322]: Accepted password for jlz from 108.61.8.124 port 56731 ssh2",
		//"Jan 12 14:44:48 irc sshd[11084]: Accepted publickey for jlz from 76.21.0.16 port 36609 ssh2",
		"Jan 12 06:49:56 irc last message repeated 6 times": Sequence{
			Token{TokenTS, FieldUnknown, "jan 12 06:49:56", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "irc", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "last", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "message", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "repeated", false, false, 0},
			Token{TokenInteger, FieldUnknown, "6", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "times", false, false, 0},
		},

		"9.26.157.44 - - [16/Jan/2003:21:22:59 -0500] \"GET http://WSsamples HTTP/1.1\" 301 315": Sequence{
			Token{TokenIPv4, FieldUnknown, "9.26.157.44", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "-", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "-", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "[", false, false, 0},
			Token{TokenTS, FieldUnknown, "16/jan/2003:21:22:59 -0500", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "]", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "\"", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "get", false, false, 0},
			Token{TokenURL, FieldUnknown, "http://wssamples", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "http/1.1", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "\"", false, false, 0},
			Token{TokenInteger, FieldUnknown, "301", false, false, 0},
			Token{TokenInteger, FieldUnknown, "315", false, false, 0},
		},

		"9.26.157.45 - - [16/Jan/2003:21:22:59 -0500] \"GET /WSsamples/ HTTP/1.1\" 200 1576": Sequence{
			Token{TokenIPv4, FieldUnknown, "9.26.157.45", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "-", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "-", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "[", false, false, 0},
			Token{TokenTS, FieldUnknown, "16/jan/2003:21:22:59 -0500", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "]", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "\"", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "get", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "/wssamples/", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "http/1.1", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "\"", false, false, 0},
			Token{TokenInteger, FieldUnknown, "200", false, false, 0},
			Token{TokenInteger, FieldUnknown, "1576", false, false, 0},
		},

		"209.36.88.3 - - [03/May/2004:01:19:07 +0000] \"GET http://npkclzicp.xihudohtd.ngm.au/abramson/eiyscmeqix.ac;jsessionid=b0l0v000u0?sid=00000000&sy=afr&kw=goldman&pb=fin&dt=selectRange&dr=0month&so=relevance&st=nw&ss=AFR&sf=article&rc=00&clsPage=0&docID=FIN0000000R0JL000D00 HTTP/1.0\" 200 27981": Sequence{
			Token{TokenIPv4, FieldUnknown, "209.36.88.3", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "-", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "-", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "[", false, false, 0},
			Token{TokenTS, FieldUnknown, "03/may/2004:01:19:07 +0000", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "]", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "\"", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "get", false, false, 0},
			Token{TokenURL, FieldUnknown, strings.ToLower("http://npkclzicp.xihudohtd.ngm.au/abramson/eiyscmeqix.ac;jsessionid=b0l0v000u0?sid=00000000&sy=afr&kw=goldman&pb=fin&dt=selectRange&dr=0month&so=relevance&st=nw&ss=AFR&sf=article&rc=00&clsPage=0&docID=FIN0000000R0JL000D00"), false, false, 0},
			Token{TokenLiteral, FieldUnknown, "http/1.0", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "\"", false, false, 0},
			Token{TokenInteger, FieldUnknown, "200", false, false, 0},
			Token{TokenInteger, FieldUnknown, "27981", false, false, 0},
		},

		"4/5/2012 17:55,172.23.1.101,1101,172.23.0.10,139, Generic Protocol Command Decode,3, [1:2100538:17] GPL NETBIOS SMB IPC$ unicode share access ,TCP TTL:128 TOS:0x0 ID:1643 IpLen:20 DgmLen:122 DF,***AP*** Seq: 0xCEF93F32  Ack: 0xC40C0BB  n: 0xFC9C  TcpLen: 20,": Sequence{
			Token{TokenTS, FieldUnknown, "4/5/2012 17:55", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ",", false, false, 0},
			Token{TokenIPv4, FieldUnknown, "172.23.1.101", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ",", false, false, 0},
			Token{TokenInteger, FieldUnknown, "1101", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ",", false, false, 0},
			Token{TokenIPv4, FieldUnknown, "172.23.0.10", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ",", false, false, 0},
			Token{TokenInteger, FieldUnknown, "139", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ",", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "generic", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "protocol", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "command", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "decode", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ",", false, false, 0},
			Token{TokenInteger, FieldUnknown, "3", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ",", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "[", false, false, 0},
			Token{TokenInteger, FieldUnknown, "1", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenInteger, FieldUnknown, "2100538", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenInteger, FieldUnknown, "17", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "]", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "gpl", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "netbios", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "smb", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "ipc$", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "unicode", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "share", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "access", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ",", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "tcp", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "ttl", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenInteger, FieldUnknown, "128", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "tos", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "0x0", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "id", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenInteger, FieldUnknown, "1643", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "iplen", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenInteger, FieldUnknown, "20", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "dgmlen", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenInteger, FieldUnknown, "122", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "df", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ",", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "***ap***", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "seq", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "0xcef93f32", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "ack", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "0xc40c0bb", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "n", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "0xfc9c", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "tcplen", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenInteger, FieldUnknown, "20", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ",", false, false, 0},
		},

		"2012-04-05 17:51:26     Local4.Info     172.23.0.1      %ASA-6-302016: Teardown UDP connection 1315632 for inside:172.23.0.2/514 to identity:172.23.0.1/514 duration 0:09:23 bytes 7999": Sequence{
			Token{TokenTS, FieldUnknown, "2012-04-05 17:51:26", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "local4.info", false, false, 0},
			Token{TokenIPv4, FieldUnknown, "172.23.0.1", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "%asa-6-302016", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "teardown", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "udp", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "connection", false, false, 0},
			Token{TokenInteger, FieldUnknown, "1315632", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "for", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "inside", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenIPv4, FieldUnknown, "172.23.0.2", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "/", false, false, 0},
			Token{TokenInteger, FieldUnknown, "514", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "to", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "identity", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenIPv4, FieldUnknown, "172.23.0.1", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "/", false, false, 0},
			Token{TokenInteger, FieldUnknown, "514", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "duration", false, false, 0},
			Token{TokenInteger, FieldUnknown, "0", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenInteger, FieldUnknown, "09", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenInteger, FieldUnknown, "23", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "bytes", false, false, 0},
			Token{TokenInteger, FieldUnknown, "7999", false, false, 0},
		},

		"2012-04-05 17:54:47     Local4.Info     172.23.0.1      %ASA-6-302015: Built outbound UDP connection 1315679 for outside:193.0.14.129/53 (193.0.14.129/53) to inside:172.23.0.10/64048 (10.32.0.1/52130)": Sequence{
			Token{TokenTS, FieldUnknown, "2012-04-05 17:54:47", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "local4.info", false, false, 0},
			Token{TokenIPv4, FieldUnknown, "172.23.0.1", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "%asa-6-302015", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "built", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "outbound", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "udp", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "connection", false, false, 0},
			Token{TokenInteger, FieldUnknown, "1315679", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "for", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "outside", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenIPv4, FieldUnknown, "193.0.14.129", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "/", false, false, 0},
			Token{TokenInteger, FieldUnknown, "53", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "(", false, false, 0},
			Token{TokenIPv4, FieldUnknown, "193.0.14.129", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "/", false, false, 0},
			Token{TokenInteger, FieldUnknown, "53", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ")", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "to", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "inside", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenIPv4, FieldUnknown, "172.23.0.10", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "/", false, false, 0},
			Token{TokenInteger, FieldUnknown, "64048", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "(", false, false, 0},
			Token{TokenIPv4, FieldUnknown, "10.32.0.1", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "/", false, false, 0},
			Token{TokenInteger, FieldUnknown, "52130", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ")", false, false, 0},
		},

		"id=firewall time=\"2005-03-18 14:01:43\" fw=TOPSEC priv=4 recorder=kernel type=conn policy=504 proto=TCP rule=deny src=210.82.121.91 sport=4958 dst=61.229.37.85 dport=23124 smac=00:0b:5f:b2:1d:80 dmac=00:04:c1:8b:d8:82": Sequence{
			Token{TokenLiteral, FieldUnknown, "id", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenString, FieldUnknown, "firewall", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "time", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "\"", false, false, 0},
			Token{TokenTS, FieldUnknown, "2005-03-18 14:01:43", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "\"", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "fw", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenString, FieldUnknown, "topsec", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "priv", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenInteger, FieldUnknown, "4", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "recorder", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenString, FieldUnknown, "kernel", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "type", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenString, FieldUnknown, "conn", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "policy", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenInteger, FieldUnknown, "504", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "proto", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenString, FieldUnknown, "tcp", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "rule", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenString, FieldUnknown, "deny", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "src", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenIPv4, FieldUnknown, "210.82.121.91", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "sport", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenInteger, FieldUnknown, "4958", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "dst", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenIPv4, FieldUnknown, "61.229.37.85", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "dport", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenInteger, FieldUnknown, "23124", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "smac", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenMac, FieldUnknown, "00:0b:5f:b2:1d:80", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "dmac", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenMac, FieldUnknown, "00:04:c1:8b:d8:82", false, true, 0},
		},

		"mar 01 09:42:03.875 pffbisvr smtp[2424]: 334 warning: denied access to command 'ehlo vishwakstg1.msn.vishwak.net' from [209.235.210.30]": Sequence{
			Token{TokenTS, FieldUnknown, "mar 01 09:42:03.875", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "pffbisvr", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "smtp", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "[", false, false, 0},
			Token{TokenInteger, FieldUnknown, "2424", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "]", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenInteger, FieldUnknown, "334", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "warning", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "denied", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "access", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "to", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "command", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "'", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "ehlo vishwakstg1.msn.vishwak.net", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "'", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "from", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "[", false, false, 0},
			Token{TokenIPv4, FieldUnknown, "209.235.210.30", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "]", false, false, 0},
		},

		"may  2 19:00:02 dlfssrv sendmail[18980]: taa18980: from user daemon: size is 596, class is 0, priority is 30596, and nrcpts=1, message id is <200305021400.taa18980@dlfssrv.in.ibm.com>, relay=daemon@localhost": Sequence{
			Token{TokenTS, FieldUnknown, "may  2 19:00:02", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "dlfssrv", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "sendmail", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "[", false, false, 0},
			Token{TokenInteger, FieldUnknown, "18980", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "]", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "taa18980", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "from", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "user", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "daemon", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "size", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "is", false, false, 0},
			Token{TokenInteger, FieldUnknown, "596", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ",", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "class", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "is", false, false, 0},
			Token{TokenInteger, FieldUnknown, "0", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ",", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "priority", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "is", false, false, 0},
			Token{TokenInteger, FieldUnknown, "30596", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ",", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "and", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "nrcpts", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenInteger, FieldUnknown, "1", false, true, 0},
			Token{TokenLiteral, FieldUnknown, ",", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "message", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "id", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "is", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "<", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "200305021400.taa18980@dlfssrv.in.ibm.com", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ">", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ",", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "relay", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenString, FieldUnknown, "daemon@localhost", false, true, 0},
		},

		"mar 01 09:45:02.596 pffbisvr smtp[2424]: 121 statistics: duration=181.14 user=<egreetings@vishwak.com> id=zduqd sent=1440 rcvd=356 srcif=d45f49a2-b30 src=209.235.210.30/61663 cldst=192.216.179.206/25 svsrc=172.17.74.195/8423 dstif=fd3c875c-064 dst=172.17.74.52/25 op=\"to 1 recips\" arg=<vishwakstg1ojte15fo000033b4@vishwakstg1.msn.vishwak.net> result=\"250 m2004030109385301402 message accepted for delivery\" proto=smtp rule=131 (denied access to command 'ehlo vishwakstg1.msn.vishwak.net' from [209.235.210.30])": Sequence{
			Token{TokenTS, FieldUnknown, "mar 01 09:45:02.596", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "pffbisvr", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "smtp", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "[", false, false, 0},
			Token{TokenInteger, FieldUnknown, "2424", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "]", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenInteger, FieldUnknown, "121", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "statistics", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "duration", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenFloat, FieldUnknown, "181.14", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "user", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "<", false, false, 0},
			Token{TokenString, FieldUnknown, "egreetings@vishwak.com", false, true, 0},
			Token{TokenLiteral, FieldUnknown, ">", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "id", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenString, FieldUnknown, "zduqd", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "sent", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenInteger, FieldUnknown, "1440", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "rcvd", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenInteger, FieldUnknown, "356", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "srcif", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenString, FieldUnknown, "d45f49a2-b30", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "src", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenIPv4, FieldUnknown, "209.235.210.30", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "/", false, false, 0},
			Token{TokenInteger, FieldUnknown, "61663", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "cldst", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenIPv4, FieldUnknown, "192.216.179.206", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "/", false, false, 0},
			Token{TokenInteger, FieldUnknown, "25", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "svsrc", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenIPv4, FieldUnknown, "172.17.74.195", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "/", false, false, 0},
			Token{TokenInteger, FieldUnknown, "8423", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "dstif", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenString, FieldUnknown, "fd3c875c-064", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "dst", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenIPv4, FieldUnknown, "172.17.74.52", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "/", false, false, 0},
			Token{TokenInteger, FieldUnknown, "25", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "op", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "\"", false, false, 0},
			Token{TokenString, FieldUnknown, "to", false, true, 0},
			Token{TokenInteger, FieldUnknown, "1", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "recips", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "\"", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "arg", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "<", false, false, 0},
			Token{TokenString, FieldUnknown, "vishwakstg1ojte15fo000033b4@vishwakstg1.msn.vishwak.net", false, true, 0},
			Token{TokenLiteral, FieldUnknown, ">", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "result", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "\"", false, false, 0},
			Token{TokenInteger, FieldUnknown, "250", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "m2004030109385301402", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "message", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "accepted", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "for", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "delivery", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "\"", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "proto", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenString, FieldUnknown, "smtp", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "rule", true, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenInteger, FieldUnknown, "131", false, true, 0},
			Token{TokenLiteral, FieldUnknown, "(", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "denied", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "access", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "to", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "command", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "'", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "ehlo vishwakstg1.msn.vishwak.net", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "'", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "from", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "[", false, false, 0},
			Token{TokenIPv4, FieldUnknown, "209.235.210.30", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "]", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ")", false, false, 0},
		},

		"%createtime% %apphost% %appname% : %srcuser% : tty = %string% ; pwd = %string% ; user = %dstuser% ; command = %method-10%": Sequence{
			Token{TokenTS, FieldCreateTime, "%createtime%", false, false, 0},
			Token{TokenString, FieldAppHost, "%apphost%", false, false, 0},
			Token{TokenString, FieldAppName, "%appname%", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenString, FieldSrcUser, "%srcuser%", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ":", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "tty", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenString, FieldUnknown, "%string%", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ";", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "pwd", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenString, FieldUnknown, "%string%", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ";", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "user", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenString, FieldDstUser, "%dstuser%", false, false, 0},
			Token{TokenLiteral, FieldUnknown, ";", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "command", false, false, 0},
			Token{TokenLiteral, FieldUnknown, "=", false, false, 0},
			Token{TokenString, FieldMethod, "%method-10%", false, false, 10},
		},
	}
)

func TestMessageScan(t *testing.T) {
	msg := &message{}

	for line, tokens := range messages {
		msg.data = line

		err := msg.tokenize()
		assert.NoError(t, true, err)
		assert.Equal(t, true, tokens, msg.tokens)
	}
}
